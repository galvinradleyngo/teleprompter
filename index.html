<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Teleprompter ‚Äî Fixed Width & Font (Synced, Public Cloud Save)</title>
<style>
  :root{
    --fontSize: 64px;        /* fixed px font size */
    --colWidthPx: 1000px;    /* fixed content width */
    --padTBpx: 0px;          /* computed from viewer height */
    --guideY: 35%;
    --labelColEm: 2.2em;     /* gutter for A‚ÄìZ */
    --labelColor: #64b5f6;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#000;color:#fff;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  body{display:flex;flex-direction:column;min-height:100vh}

  /* Hide/show tools */
  body.ui-hidden .topbar{display:none}
  .ui-restore{position:fixed;top:10px;right:10px;z-index:9999;display:none}
  body.ui-hidden .ui-restore{display:block}

  .topbar{position:sticky;top:0;z-index:10;background:#0e0e0e;border-bottom:1px solid #222}
  .topbar-inner{max-width:1400px;margin:0 auto;padding:12px 16px;display:grid;grid-template-columns:1fr auto;gap:12px}
  .controls{display:grid;grid-template-columns:repeat(4, minmax(220px, 1fr));gap:10px 16px;align-items:center}
  .controls label{display:flex;align-items:center;justify-content:space-between;gap:12px;font-size:14px;background:#0b0b0b;border:1px solid #222;border-radius:12px;padding:8px 10px}
  .controls input[type="range"]{width:180px}
  .muted{opacity:.75;font-size:12px}
  .small{font-size:12px}

  .actions{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
  .actions .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
  .toggles{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .toggle{display:flex;gap:10px;align-items:center;background:#0b0b0b;border:1px solid #222;border-radius:999px;padding:8px 12px;font-size:14px}
  .toggle input{margin:0}

  button{background:#1f1f1f;color:#fff;border:1px solid #333;border-radius:12px;padding:10px 14px;cursor:pointer}
  button:hover{background:#262626}
  .ui-pill{border-radius:999px;padding:8px 12px;border:1px solid #333;background:#121212}

  .script-wrap{max-width:1400px;margin:0 auto;padding:0 16px 10px}
  .script-wrap label{display:block;margin:6px 0 6px;font-size:12px;opacity:.9}
  textarea{height:120px;width:100%;resize:vertical;background:#0a0a0a;color:#fff;border:1px solid #222;border-radius:10px;padding:10px}

  .viewer{position:relative;overflow:auto;flex:1;border-top:1px solid #222}
  .content{
    font-size:var(--fontSize);
    line-height:1.2;
    padding:var(--padTBpx) 0;     /* no side padding; width is fixed */
    width:var(--colWidthPx);
    margin:0 auto;                /* center column */
    white-space:pre-wrap;word-break:break-word
  }
  .guide{position:absolute;left:0;right:0;height:2px;background:#f44336;top:var(--guideY);opacity:.8;pointer-events:none;z-index:2}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#111;border:1px solid #333;border-radius:6px;padding:2px 6px}
  .mirrorX{transform:scaleX(-1)}
  .flipY{transform:scaleY(-1)}
  .viewer:focus{outline:2px solid #2a7fff}

  /* Paragraph labels A‚ÄìZ */
  .content .para{
    display:grid;
    grid-template-columns: var(--labelColEm) 1fr;
    column-gap: .6em;
    align-items: baseline;
    margin: .35em 0;
  }
  .content .label{
    color: var(--labelColor);
    text-align:right;
    user-select:none;
    font-weight:600;
    letter-spacing:.03em;
  }
  .content .ptext{white-space:pre-wrap}

  /* Load dialog */
  dialog#loadDialog{border:1px solid #333;background:#0f0f0f;color:#fff;border-radius:16px;padding:0;max-width:640px;width:90%}
  .dlg-head{padding:14px 16px;border-bottom:1px solid #222;display:flex;align-items:center;justify-content:space-between}
  .dlg-body{padding:10px 16px;max-height:60vh;overflow:auto}
  .dlg-foot{padding:12px 16px;border-top:1px solid #222;display:flex;justify-content:flex-end}
  .saved-item{display:grid;grid-template-columns:1fr auto;gap:6px 12px;align-items:center;border:1px solid #222;border-radius:12px;padding:10px;margin:8px 0;background:#0b0b0b}
  .saved-title{font-weight:600}
  .saved-meta{font-size:12px;opacity:.8}
  .saved-actions{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
  <!-- Restore pill (only shows when UI is hidden) -->
  <button id="restoreUIBtn" class="ui-restore ui-pill" title="Show tools (T)">Show Tools</button>

  <!-- Sticky Top Toolbar -->
  <div class="topbar">
    <div class="topbar-inner">
      <div>
        <h2 style="margin:0;">Operator</h2>
        <div class="muted small" id="instructions">
          Keys: <span class="kbd">Space</span> autoscroll ¬∑ <span class="kbd">‚Üë/‚Üì</span> nudge ¬∑
          <span class="kbd">G</span> guide ¬∑ <span class="kbd">A‚ÄìZ</span> jump to paragraph ¬∑
          <span class="kbd">T</span> tools ¬∑ <span class="kbd">F</span> fullscreen ¬∑ <span class="kbd">‚åò/Ctrl+S</span> save
        </div>
      </div>
      <div class="actions">
        <div class="row">
          <button id="openPrompter">Open Prompter Window</button>
          <button id="prompterFS" class="ui-pill" title="Try to fullscreen the Prompter window">Prompter Fullscreen</button>
          <button id="fullscreenOp" class="ui-pill" title="F to toggle fullscreen">Fullscreen</button>
          <button id="toggleUIBtn" class="ui-pill" title="T to toggle tools">Hide Tools</button>
        </div>
        <div class="toggles">
          <label class="toggle"><input id="showGuide" type="checkbox" checked> Show Guide</label>
          <label class="toggle"><input id="autoscroll" type="checkbox"> Autoscroll</label>
          <label class="toggle"><input id="invertH" type="checkbox"> Mirror (Prompter only)</label>
          <label class="toggle"><input id="invertV" type="checkbox"> Flip (Prompter only)</label>
        </div>
      </div>
    </div>

    <div class="topbar-inner" style="grid-template-columns:1fr;gap:10px 16px;">
      <div class="controls" id="controls">
        <label>Font Size <span style="display:flex;gap:10px;align-items:center"><input id="fontSize" type="range" min="20" max="160" value="64"><span id="fontSizeVal">64px</span></span></label>
        <label>Column Width <span style="display:flex;gap:10px;align-items:center"><input id="colWidth" type="range" min="600" max="1600" step="10" value="1000"><span id="colWidthVal">1000px</span></span></label>
        <label>Guide Position <span style="display:flex;gap:10px;align-items:center"><input id="guidePos" type="range" min="5" max="90" value="35"><span id="guideVal">35%</span></span></label>
        <label>Speed <span style="display:flex;gap:10px;align-items:center"><input id="speed" type="range" min="10" max="300" step="5" value="80"><span id="speedVal">80 px/s</span></span></label>
      </div>
    </div>

    <div class="script-wrap">
      <label>Script</label>
      <textarea id="script" placeholder="Type or paste your script here..."></textarea>
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;margin-top:6px">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="applyScript">Load to Preview & Prompter</button>
          <button id="saveScript" title="Save/Update script (public)">üíæ Save</button>
          <button id="loadScript" title="Load a saved script (public)">üìÇ Load</button>
        </div>
        <span id="status" class="muted">‚Äì</span>
      </div>
    </div>
  </div>

  <!-- Full-width Operator Preview -->
  <div class="viewer" id="viewer" tabindex="0" aria-label="Operator preview (scroll area)">
    <div class="guide" id="guide"></div>
    <div class="content" id="content"></div>
  </div>

  <!-- Load dialog -->
  <dialog id="loadDialog">
    <div class="dlg-head">
      <strong>Saved Scripts (Public)</strong>
      <button id="closeDialog">Close</button>
    </div>
    <div class="dlg-body">
      <div id="savedList" class="saved-list"></div>
    </div>
    <div class="dlg-foot">
      <span class="muted">Click ‚ÄúLoad‚Äù to replace the current script. (Public list)</span>
    </div>
  </dialog>

<script>
/* ===== Teleprompter logic (Operator authoritative; fixed width & font) ===== */
(function(){
  const $ = (id)=>document.getElementById(id);

  const state = {
    text:'',
    fontSize:64,
    colWidth:1000,      // px
    padTB:0,            // % of viewer height
    guidePos:35,
    guideVisible:true,
    speed:80,
    autoscroll:false,
    invertH:false,
    invertV:false,
    scrollTop:0
  };

  const viewer = $('viewer');
  const content = $('content');
  const guide = $('guide');
  const scriptBox = $('script');
  const status = $('status');

  const fontSize = $('fontSize'), fontSizeVal = $('fontSizeVal');
  const colWidth = $('colWidth'), colWidthVal = $('colWidthVal');
  const guidePos = $('guidePos'), guideVal = $('guideVal');
  const speed = $('speed'), speedVal = $('speedVal');
  const showGuide = $('showGuide');
  const autoscroll = $('autoscroll');
  const invertH = $('invertH');
  const invertV = $('invertV');
  const applyBtn = $('applyScript');

  const toggleUIBtn   = $('toggleUIBtn');
  const restoreUIBtn  = $('restoreUIBtn');
  const fullscreenOp  = $('fullscreenOp');
  const prompterFSBtn = $('prompterFS');

  let prompterWin = null, pingTimer = null, autosTimer = null, isRemoteScroll = false;
  let labelMap = {};

  function buildParagraphs(text, container){
    if (!container) return;
    container.innerHTML = '';
    labelMap = {};
    const normalized = (text || '').replace(/\r\n/g, '\n');
    const paras = normalized.split(/\n\s*\n+/);
    const MAX = 26;
    const A = 'A'.charCodeAt(0);
    for (let i = 0; i < paras.length; i++){
      const raw = paras[i];
      if (!raw.trim() && i !== 0) continue;
      const para = document.createElement('div');
      para.className = 'para';
      const label = (i < MAX) ? String.fromCharCode(A + i) : '';
      if (label){ para.setAttribute('data-label', label); para.id = 'para-' + label; }
      const lbl = document.createElement('div');
      lbl.className = 'label';
      lbl.textContent = label || '';
      const ptext = document.createElement('div');
      ptext.className = 'ptext';
      ptext.textContent = raw;
      para.appendChild(lbl); para.appendChild(ptext);
      container.appendChild(para);
      if (label) labelMap[label] = para;
    }
  }

  function updatePadTBpx(){
    const h = viewer?.clientHeight || 0;
    const px = h * (state.padTB/100);
    document.documentElement.style.setProperty('--padTBpx', px + 'px');
  }

  function syncUIToggleLabel(){
    const hidden = document.body.classList.contains('ui-hidden');
    if (toggleUIBtn) toggleUIBtn.textContent = hidden ? 'Show Tools' : 'Hide Tools';
  }
  function toggleUI(){
    document.body.classList.toggle('ui-hidden');
    syncUIToggleLabel();
    updatePadTBpx();
  }
  toggleUIBtn?.addEventListener('click', toggleUI);
  restoreUIBtn?.addEventListener('click', toggleUI);

  async function toggleFullscreen(){
    try{
      if (!document.fullscreenElement){
        await document.documentElement.requestFullscreen();
        if (fullscreenOp) fullscreenOp.textContent = 'Exit Fullscreen';
      }else{
        await document.exitFullscreen();
        if (fullscreenOp) fullscreenOp.textContent = 'Fullscreen';
      }
    }catch(e){ console.warn('Fullscreen failed:', e); }
  }
  fullscreenOp?.addEventListener('click', toggleFullscreen);
  document.addEventListener('fullscreenchange', ()=>{
    if (fullscreenOp) fullscreenOp.textContent = document.fullscreenElement ? 'Exit Fullscreen' : 'Fullscreen';
    updatePadTBpx();
    broadcastState();
  });

  /* ---- Prompter open ---- */
  function prompterHTML(){ return `<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Prompter</title>
<style>
:root{
  --fontSize:${state.fontSize}px;
  --colWidthPx:${state.colWidth}px;
  --padTBpx:0px;
  --guideY:${state.guidePos}%;
  --labelColEm:2.2em;
  --labelColor:#64b5f6;
}
html,body{height:100%;margin:0;background:#000;color:#fff;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.viewer{position:relative;height:100%;overflow:auto;border-top:1px solid #222}
.content{
  font-size:var(--fontSize);
  line-height:1.2;
  padding:var(--padTBpx) 0;
  width:var(--colWidthPx);
  margin:0 auto;
  white-space:pre-wrap;word-break:break-word
}
.guide{position:absolute;top:var(--guideY);left:0;right:0;height:2px;background:#f44336;opacity:.8;pointer-events:none;z-index:2}
.mirrorX{transform:scaleX(-1)}
.flipY{transform:scaleY(-1)}
.content .para{display:grid;grid-template-columns: var(--labelColEm) 1fr;column-gap:.6em;align-items:baseline;margin:.35em 0}
.content .label{color:var(--labelColor);text-align:right;user-select:none;font-weight:600;letter-spacing:.03em}
.content .ptext{white-space:pre-wrap}
.fs-fab{position:fixed;top:10px;right:10px;z-index:9999}
.fs-pill{border-radius:999px;padding:8px 12px;border:1px solid #333;background:#121212;color:#fff}

/* One-tap FS overlay */
#fsOverlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9998;
  font-size:22px;text-align:center;padding:24px
}
#fsOverlay .inner{background:#0d0d0d;border:1px solid #333;border-radius:14px;padding:18px 22px;max-width:600px}
#fsOverlay .inner strong{display:block;margin-bottom:8px}
</style>
</head><body>
  <div class="viewer" id="v">
    <div class="guide" id="g"></div>
    <div class="content" id="c"></div>
  </div>
  <div class="fs-fab"><button id="fsBtnP" class="fs-pill" title="F to toggle fullscreen">Fullscreen</button></div>
  <div id="fsOverlay"><div class="inner">
    <strong>Almost there‚Ä¶</strong>
    Click anywhere in this window to enter fullscreen.<br/>Browsers require a click inside the window for fullscreen.
  </div></div>
<script>(function(){
  const viewer=document.getElementById('v'), content=document.getElementById('c'), guide=document.getElementById('g');
  const fsBtn=document.getElementById('fsBtnP');
  const fsOverlay=document.getElementById('fsOverlay');
  let state={text:'',fontSize:64,colWidth:1000,padTB:0,guidePos:35,guideVisible:true,speed:80,autoscroll:false,invertH:false,invertV:false,scrollTop:0};
  let labelMap = {};
  let fsArmed = false;

  function updatePadTBpx(){
    const h = viewer?.clientHeight || 0;
    const px = h * (state.padTB/100);
    document.documentElement.style.setProperty('--padTBpx', px + 'px');
  }
  function rebuildLabelMap(){
    labelMap = {};
    content.querySelectorAll('.para[data-label]').forEach(el=>{
      const L = el.getAttribute('data-label');
      if (L) labelMap[L] = el;
    });
  }
  function apply(d){
    if (d && d.state) state = d.state;
    document.documentElement.style.setProperty('--fontSize',state.fontSize+'px');
    document.documentElement.style.setProperty('--colWidthPx',state.colWidth+'px');
    document.documentElement.style.setProperty('--guideY',state.guidePos+'%');
    guide.style.display = state.guideVisible ? 'block' : 'none';
    content.classList.toggle('mirrorX',!!state.invertH);
    content.classList.toggle('flipY',!!state.invertV);
    if (d && typeof d.html==='string'){ content.innerHTML = d.html; }
    updatePadTBpx();
    rebuildLabelMap();
    viewer.scrollTop = state.scrollTop || 0;   // Operator decides scroll
  }
  function jumpToLabel(letter){
    const L=(letter||'').toUpperCase();
    const el=labelMap[L]; if(!el) return;
    const guidePx=viewer.clientHeight*(state.guidePos/100);
    const target=Math.max(0, el.offsetTop - guidePx);
    viewer.scrollTop=target;
  }

  function hasFS(){ return !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement); }
  async function enterFS(){
    const el = document.documentElement;
    if (el.requestFullscreen) return el.requestFullscreen();
    if (el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
    if (el.msRequestFullscreen) return el.msRequestFullscreen();
  }
  async function exitFS(){
    if (document.exitFullscreen) return document.exitFullscreen();
    if (document.webkitExitFullscreen) return document.webkitExitFullscreen();
    if (document.msExitFullscreen) return document.msExitFullscreen();
  }
  async function toggleFS(){
    try{
      if (!hasFS()){
        await enterFS();
        fsBtn
