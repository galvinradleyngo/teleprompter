<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Teleprompter ‚Äî Public Cloud Save (A‚ÄìZ Paragraphs, Mirror/Flip, Offline, Fullscreen)</title>
<style>
  :root{
    --fontSize: 64px;
    --padLRvw: 8;
    --padTBpx: 0px;      /* computed from viewer height */
    --guideY: 35%;
    --labelColEm: 2.2em; /* gutter for A‚ÄìZ */
    --labelColor: #64b5f6;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#000;color:#fff;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  body{display:flex;flex-direction:column;min-height:100vh}

  /* Hide/show tools */
  body.ui-hidden .topbar{display:none}
  .ui-restore{position:fixed;top:10px;right:10px;z-index:9999;display:none}
  body.ui-hidden .ui-restore{display:block}

  .topbar{position:sticky;top:0;z-index:10;background:#0e0e0e;border-bottom:1px solid #222}
  .topbar-inner{max-width:1400px;margin:0 auto;padding:12px 16px;display:grid;grid-template-columns:1fr auto;gap:12px}
  .controls{display:grid;grid-template-columns:repeat(4, minmax(220px, 1fr));gap:10px 16px;align-items:center}
  .controls label{display:flex;align-items:center;justify-content:space-between;gap:12px;font-size:14px;background:#0b0b0b;border:1px solid #222;border-radius:12px;padding:8px 10px}
  .controls input[type="range"]{width:180px}
  .muted{opacity:.75;font-size:12px}
  .small{font-size:12px}

  .actions{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
  .actions .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
  .toggles{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .toggle{display:flex;gap:10px;align-items:center;background:#0b0b0b;border:1px solid #222;border-radius:999px;padding:8px 12px;font-size:14px}
  .toggle input{margin:0}

  button{background:#1f1f1f;color:#fff;border:1px solid #333;border-radius:12px;padding:10px 14px;cursor:pointer}
  button:hover{background:#262626}
  .ui-pill{border-radius:999px;padding:8px 12px;border:1px solid #333;background:#121212}

  .script-wrap{max-width:1400px;margin:0 auto;padding:0 16px 10px}
  .script-wrap label{display:block;margin:6px 0 6px;font-size:12px;opacity:.9}
  textarea{height:120px;width:100%;resize:vertical;background:#0a0a0a;color:#fff;border:1px solid #222;border-radius:10px;padding:10px}

  .viewer{position:relative;overflow:auto;flex:1;border-top:1px solid #222}
  .content{font-size:var(--fontSize);line-height:1.2;padding:var(--padTBpx) calc(var(--padLRvw)*1vw);white-space:pre-wrap;word-break:break-word}
  .guide{position:absolute;left:0;right:0;height:2px;background:#f44336;top:var(--guideY);opacity:.8;pointer-events:none;z-index:2}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;background:#111;border:1px solid #333;border-radius:6px;padding:2px 6px}
  .mirrorX{transform:scaleX(-1)}
  .flipY{transform:scaleY(-1)}
  .viewer:focus{outline:2px solid #2a7fff}

  /* Paragraph labels A‚ÄìZ */
  .content .para{
    display:grid;
    grid-template-columns: var(--labelColEm) 1fr;
    column-gap: .6em;
    align-items: baseline;
    margin: .35em 0 .35em 0;
  }
  .content .label{
    color: var(--labelColor);
    text-align:right;
    user-select:none;
    font-weight:600;
    letter-spacing:.03em;
  }
  .content .ptext{white-space:pre-wrap}

  /* Load dialog */
  dialog#loadDialog{border:1px solid #333;background:#0f0f0f;color:#fff;border-radius:16px;padding:0;max-width:640px;width:90%}
  .dlg-head{padding:14px 16px;border-bottom:1px solid #222;display:flex;align-items:center;justify-content:space-between}
  .dlg-body{padding:10px 16px;max-height:60vh;overflow:auto}
  .dlg-foot{padding:12px 16px;border-top:1px solid #222;display:flex;justify-content:flex-end}
  .saved-item{display:grid;grid-template-columns:1fr auto;gap:6px 12px;align-items:center;border:1px solid #222;border-radius:12px;padding:10px;margin:8px 0;background:#0b0b0b}
  .saved-title{font-weight:600}
  .saved-meta{font-size:12px;opacity:.8}
  .saved-actions{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
  <!-- Restore pill (only shows when UI is hidden) -->
  <button id="restoreUIBtn" class="ui-restore ui-pill" title="Show tools (T)">Show Tools</button>

  <!-- Sticky Top Toolbar -->
  <div class="topbar">
    <div class="topbar-inner">
      <div>
        <h2 style="margin:0;">Operator</h2>
        <div class="muted small" id="instructions">
          Keys: <span class="kbd">Space</span> autoscroll ¬∑ <span class="kbd">‚Üë/‚Üì</span> nudge ¬∑
          <span class="kbd">G</span> guide ¬∑ <span class="kbd">A‚ÄìZ</span> jump to paragraph ¬∑
          <span class="kbd">T</span> tools ¬∑ <span class="kbd">F</span> fullscreen ¬∑ <span class="kbd">‚åò/Ctrl+S</span> save
        </div>
      </div>
      <div class="actions">
        <div class="row">
          <button id="openPrompter">Open Prompter Window</button>
          <button id="fullscreenOp" class="ui-pill" title="F to toggle fullscreen">Fullscreen</button>
          <button id="toggleUIBtn" class="ui-pill" title="T to toggle tools">Hide Tools</button>
        </div>
        <div class="toggles">
          <label class="toggle"><input id="showGuide" type="checkbox" checked> Show Guide</label>
          <label class="toggle"><input id="autoscroll" type="checkbox"> Autoscroll</label>
          <label class="toggle"><input id="invertH" type="checkbox"> Mirror (Prompter only)</label>
          <label class="toggle"><input id="invertV" type="checkbox"> Flip (Prompter only)</label>
        </div>
      </div>
    </div>

    <div class="topbar-inner" style="grid-template-columns:1fr;gap:10px 16px;">
      <div class="controls" id="controls">
        <label>Font Size <span style="display:flex;gap:10px;align-items:center"><input id="fontSize" type="range" min="20" max="160" value="64"><span id="fontSizeVal">64px</span></span></label>
        <label>Side Margin <span style="display:flex;gap:10px;align-items:center"><input id="padLR" type="range" min="0" max="20" step="1" value="8"><span id="padLRVal">8vw</span></span></label>
        <label>Guide Position <span style="display:flex;gap:10px;align-items:center"><input id="guidePos" type="range" min="5" max="90" value="35"><span id="guideVal">35%</span></span></label>
        <label>Speed <span style="display:flex;gap:10px;align-items:center"><input id="speed" type="range" min="10" max="300" step="5" value="80"><span id="speedVal">80 px/s</span></span></label>
      </div>
    </div>

    <div class="script-wrap">
      <label>Script</label>
      <textarea id="script" placeholder="Type or paste your script here..."></textarea>
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;margin-top:6px">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="applyScript">Load to Preview & Prompter</button>
          <button id="saveScript" title="Save/Update script (public)">üíæ Save</button>
          <button id="loadScript" title="Load a saved script (public)">üìÇ Load</button>
        </div>
        <span id="status" class="muted">‚Äì</span>
      </div>
    </div>
  </div>

  <!-- Full-width Operator Preview -->
  <div class="viewer" id="viewer" tabindex="0" aria-label="Operator preview (scroll area)">
    <div class="guide" id="guide"></div>
    <div class="content" id="content"></div>
  </div>

  <!-- Load dialog -->
  <dialog id="loadDialog">
    <div class="dlg-head">
      <strong>Saved Scripts (Public)</strong>
      <button id="closeDialog">Close</button>
    </div>
    <div class="dlg-body">
      <div id="savedList" class="saved-list"></div>
    </div>
    <div class="dlg-foot">
      <span class="muted">Click ‚ÄúLoad‚Äù to replace the current script. (Public list)</span>
    </div>
  </dialog>

<script>
/* ===== Teleprompter logic (Operator + Prompter HTML) ===== */
(function(){
  const $ = (id)=>document.getElementById(id);

  const state = { text:'', fontSize:64, padLR:8, padTB:0, guidePos:35, guideVisible:true, speed:80, autoscroll:false, invertH:false, invertV:false, scrollTop:0 };

  const viewer = $('viewer');
  const content = $('content');
  const guide = $('guide');
  const scriptBox = $('script');
  const status = $('status');

  const fontSize = $('fontSize'), fontSizeVal = $('fontSizeVal');
  const padLR = $('padLR'), padLRVal = $('padLRVal');
  const guidePos = $('guidePos'), guideVal = $('guideVal');
  const speed = $('speed'), speedVal = $('speedVal');
  const showGuide = $('showGuide');
  const autoscroll = $('autoscroll');
  const invertH = $('invertH');
  const invertV = $('invertV');
  const openBtn = $('openPrompter');
  const applyBtn = $('applyScript');

  const toggleUIBtn   = $('toggleUIBtn');
  const restoreUIBtn  = $('restoreUIBtn');
  const fullscreenOp  = $('fullscreenOp');

  let prompterWin = null, pingTimer = null, autosTimer = null, isRemoteScroll = false;
  let labelMap = {};

  function buildParagraphs(text, container){
    if (!container) return;
    container.innerHTML = '';
    labelMap = {};
    const normalized = (text || '').replace(/\r\n/g, '\n');
    const paras = normalized.split(/\n\s*\n+/);
    const MAX = 26;
    const A = 'A'.charCodeAt(0);
    for (let i = 0; i < paras.length; i++){
      const raw = paras[i];
      if (!raw.trim() && i !== 0) continue;
      const para = document.createElement('div');
      para.className = 'para';
      const label = (i < MAX) ? String.fromCharCode(A + i) : '';
      if (label){ para.setAttribute('data-label', label); para.id = 'para-' + label; }
      const lbl = document.createElement('div');
      lbl.className = 'label';
      lbl.textContent = label || '';
      const ptext = document.createElement('div');
      ptext.className = 'ptext';
      ptext.textContent = raw;
      para.appendChild(lbl); para.appendChild(ptext);
      container.appendChild(para);
      if (label) labelMap[label] = para;
    }
  }

  function updatePadTBpx(){
    const h = viewer?.clientHeight || 0;
    const px = h * (state.padTB/100);
    document.documentElement.style.setProperty('--padTBpx', px + 'px');
  }

  function syncUIToggleLabel(){
    const hidden = document.body.classList.contains('ui-hidden');
    if (toggleUIBtn) toggleUIBtn.textContent = hidden ? 'Show Tools' : 'Hide Tools';
  }
  function toggleUI(){
    document.body.classList.toggle('ui-hidden');
    syncUIToggleLabel();
    updatePadTBpx();
  }
  toggleUIBtn?.addEventListener('click', toggleUI);
  restoreUIBtn?.addEventListener('click', toggleUI);

  async function toggleFullscreen(){
    try{
      if (!document.fullscreenElement){
        await document.documentElement.requestFullscreen();
        if (fullscreenOp) fullscreenOp.textContent = 'Exit Fullscreen';
      }else{
        await document.exitFullscreen();
        if (fullscreenOp) fullscreenOp.textContent = 'Fullscreen';
      }
    }catch(e){ console.warn('Fullscreen failed:', e); }
  }
  fullscreenOp?.addEventListener('click', toggleFullscreen);
  document.addEventListener('fullscreenchange', ()=>{
    if (fullscreenOp) fullscreenOp.textContent = document.fullscreenElement ? 'Exit Fullscreen' : 'Fullscreen';
    updatePadTBpx();
    broadcastState();
  });

  function stopOpAuto(){ if(autosTimer){ cancelAnimationFrame(autosTimer); autosTimer=null; } }
  function stepOp(){ const sp = state.speed || 0; let last = performance.now();
    function tick(t){ const dt = (t - last) / 1000; last = t; viewer.scrollTop += sp * dt; state.scrollTop = viewer.scrollTop; send({type:'scroll', scrollTop: state.scrollTop}); autosTimer = requestAnimationFrame(tick); }
    autosTimer = requestAnimationFrame(tick);
  }
  function manageAuto(){ stopOpAuto(); if(state.autoscroll){ if(!prompterWin || prompterWin.closed){ stepOp(); } } }

  function render(){
    document.documentElement.style.setProperty('--fontSize', state.fontSize + 'px');
    document.documentElement.style.setProperty('--padLRvw', state.padLR);
    document.documentElement.style.setProperty('--guideY', state.guidePos + '%');
    if (guide) guide.style.display = state.guideVisible ? 'block' : 'none';
    if (content) content.classList.remove('mirrorX','flipY'); // operator is never flipped
    isRemoteScroll = true; if (viewer) viewer.scrollTop = state.scrollTop || 0; isRemoteScroll = false;

    if (fontSize){ fontSize.value = state.fontSize; fontSizeVal.textContent = state.fontSize + 'px'; }
    if (padLR){ padLR.value = state.padLR; padLRVal.textContent = state.padLR + 'vw'; }
    if (guidePos){ guidePos.value = state.guidePos; guideVal.textContent = state.guidePos + '%'; }
    if (speed){ speed.value = state.speed; speedVal.textContent = state.speed + ' px/s'; }
    if (showGuide) showGuide.checked = !!state.guideVisible;
    if (autoscroll) autoscroll.checked = !!state.autoscroll;
    if (invertH) invertH.checked = !!state.invertH;
    if (invertV) invertV.checked = !!state.invertV;

    buildParagraphs(state.text, content);
    updatePadTBpx();
  }

  function send(msg){ if (prompterWin && !prompterWin.closed){ prompterWin.postMessage(msg, '*'); } }
  function broadcastState(){ send({type:'state', state}); }

  function jumpToLabel(letter){
    const L = (letter||'').toUpperCase();
    const el = labelMap[L];
    if (!el || !viewer) return;
    const guidePx = viewer.clientHeight * (state.guidePos/100);
    const target = Math.max(0, el.offsetTop - guidePx);
    viewer.scrollTop = target;
    state.scrollTop = viewer.scrollTop;
    send({type:'jump', label: L});
  }

  function prompterHTML(){ return `<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Prompter</title>
<style>
:root{
  --fontSize:${state.fontSize}px;
  --padLRvw:${state.padLR};
  --padTBpx:0px;
  --guideY:${state.guidePos}%;
  --labelColEm:2.2em;
  --labelColor:#64b5f6;
}
html,body{height:100%;margin:0;background:#000;color:#fff;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.viewer{position:relative;height:100%;overflow:auto;border-top:1px solid #222}
.content{font-size:var(--fontSize);line-height:1.2;padding:var(--padTBpx) calc(var(--padLRvw)*1vw);white-space:pre-wrap;word-break:break-word}
.guide{position:absolute;top:var(--guideY);left:0;right:0;height:2px;background:#f44336;opacity:.8;pointer-events:none;z-index:2}
.mirrorX{transform:scaleX(-1)}
.flipY{transform:scaleY(-1)}
.content .para{display:grid;grid-template-columns: var(--labelColEm) 1fr;column-gap:.6em;align-items:baseline;margin:.35em 0}
.content .label{color:var(--labelColor);text-align:right;user-select:none;font-weight:600;letter-spacing:.03em}
.content .ptext{white-space:pre-wrap}
.fs-fab{position:fixed;top:10px;right:10px;z-index:9999}
.fs-pill{border-radius:999px;padding:8px 12px;border:1px solid #333;background:#121212;color:#fff}
</style>
</head><body>
  <div class="viewer" id="v">
    <div class="guide" id="g"></div>
    <div class="content" id="c"></div>
  </div>
  <div class="fs-fab"><button id="fsBtnP" class="fs-pill" title="F to toggle fullscreen">Fullscreen</button></div>
<script>(function(){
  const viewer=document.getElementById('v'), content=document.getElementById('c'), guide=document.getElementById('g');
  const fsBtn=document.getElementById('fsBtnP');
  let state={text:'',fontSize:64,padLR:8,padTB:0,guidePos:35,guideVisible:true,speed:80,autoscroll:false,invertH:false,invertV:false,scrollTop:0};
  let autosTimer=null, isRemoteScroll=false, suppressParent=false;
  let labelMap = {};

  function updatePadTBpx(){
    const h = viewer?.clientHeight || 0;
    const px = h * (state.padTB/100);
    document.documentElement.style.setProperty('--padTBpx', px + 'px');
  }

  function buildParagraphs(text){
    content.innerHTML='';
    labelMap={};
    const normalized=(text||'').replace(/\\r\\n/g,'\\n');
    const paras=normalized.split(/\\n\\s*\\n+/);
    const MAX=26, A='A'.charCodeAt(0);
    for(let i=0;i<paras.length;i++){
      const raw=paras[i];
      if(!raw.trim() && i!==0) continue;
      const para=document.createElement('div'); para.className='para';
      const label=(i<MAX)?String.fromCharCode(A+i):'';
      if(label){ para.setAttribute('data-label',label); para.id='p-'+label; }
      const L=document.createElement('div'); L.className='label'; L.textContent=label||'';
      const T=document.createElement('div'); T.className='ptext'; T.textContent=raw;
      para.appendChild(L); para.appendChild(T); content.appendChild(para);
      if(label) labelMap[label]=para;
    }
  }

  function apply(){
    document.documentElement.style.setProperty('--fontSize',state.fontSize+'px');
    document.documentElement.style.setProperty('--padLRvw',state.padLR);
    document.documentElement.style.setProperty('--guideY',state.guidePos+'%');
    guide.style.display=state.guideVisible?'block':'none';
    content.classList.toggle('mirrorX',!!state.invertH);
    content.classList.toggle('flipY',!!state.invertV);
    buildParagraphs(state.text);
    updatePadTBpx();
    isRemoteScroll=true; viewer.scrollTop=state.scrollTop||0; isRemoteScroll=false;
    if(autosTimer){cancelAnimationFrame(autosTimer);autosTimer=null;}
    if(state.autoscroll){ step(); }
  }
  function step(){
    const sp=state.speed||0; let last=performance.now();
    function tick(t){ const dt=(t-last)/1000; last=t; viewer.scrollTop+=sp*dt; if(!suppressParent){ window.parent && window.parent.postMessage({type:'scroll',scrollTop:viewer.scrollTop},'*'); } autosTimer=requestAnimationFrame(tick); }
    autosTimer=requestAnimationFrame(tick);
  }

  function jumpToLabel(letter){
    const L=(letter||'').toUpperCase();
    const el=labelMap[L]; if(!el) return;
    const guidePx=viewer.clientHeight*(state.guidePos/100);
    const target=Math.max(0, el.offsetTop - guidePx);
    suppressParent=true;
    viewer.scrollTop=target;
    setTimeout(()=>{ suppressParent=false; }, 120);
  }

  async function toggleFS(){
    try{
      if (!document.fullscreenElement){
        await document.documentElement.requestFullscreen();
        fsBtn.textContent='Exit Fullscreen';
      } else {
        await document.exitFullscreen();
        fsBtn.textContent='Fullscreen';
      }
    }catch(e){ console.warn('Prompter fullscreen failed:', e); }
  }
  fsBtn.addEventListener('click', toggleFS);
  document.addEventListener('fullscreenchange', ()=>{ fsBtn.textContent = document.fullscreenElement ? 'Exit Fullscreen' : 'Fullscreen'; updatePadTBpx(); });

  window.addEventListener('message',(e)=>{ const d=e.data||{};
    if(d.type==='ping'){ window.parent && window.parent.postMessage({type:'pong'},'*'); }
    else if(d.type==='state'){ state=d.state||state; apply(); }
    else if(d.type==='scroll'){ isRemoteScroll=true; viewer.scrollTop=d.scrollTop||0; isRemoteScroll=false; }
    else if(d.type==='jump'){ jumpToLabel(d.label); }
  });
  viewer.addEventListener('scroll',()=>{ if(isRemoteScroll || suppressParent) return; window.parent && window.parent.postMessage({type:'scroll',scrollTop:viewer.scrollTop},'*'); },{passive:true});
  window.addEventListener('resize', updatePadTBpx);
  window.parent && window.parent.postMessage({type:'ready'},'*');

  document.addEventListener('keydown',(e)=>{
    if(e.key==='f' || e.key==='F'){ e.preventDefault(); toggleFS(); return; }
    if(/^[a-zA-Z]$/.test(e.key)){ e.preventDefault(); jumpToLabel(e.key); }
  });
})();<\/script>
</body></html>`; }

  function openPrompter(){
    if (status) status.textContent = 'Opening prompter‚Ä¶';
    if (prompterWin && !prompterWin.closed){ try{prompterWin.close();}catch{} }
    prompterWin = window.open('', 'TeleprompterWindow', 'popup=yes,width=1200,height=800');
    if(!prompterWin){ alert('Pop-up blocked. Please allow pop-ups for this site.'); if(status) status.textContent='Popup blocked.'; return; }
    prompterWin.document.open(); prompterWin.document.write(prompterHTML()); prompterWin.document.close();
    if (pingTimer) clearInterval(pingTimer);
    pingTimer = setInterval(()=>{ try{ if (prompterWin && !prompterWin.closed) prompterWin.postMessage({type:'ping'}, '*'); }catch{} }, 500);
    setTimeout(()=>{ broadcastState(); if(status) status.textContent='Prompter ready.'; manageAuto(); }, 300);
  }

  openBtn?.addEventListener('click', openPrompter);

  applyBtn?.addEventListener('click', ()=>{ state.text = scriptBox?.value || ''; render(); broadcastState(); try{ localStorage.setItem('tp_text', state.text); }catch{} });

  [fontSize,padLR,guidePos,speed].forEach(inp=>{
    inp?.addEventListener('input', ()=>{
      if (!inp) return;
      state[inp.id==='fontSize'?'fontSize': inp.id==='padLR'?'padLR': inp.id==='guidePos'?'guidePos':'speed'] = +inp.value;
      render(); broadcastState();
      try{ localStorage.setItem('tp_ui', JSON.stringify({fontSize:state.fontSize,padLR:state.padLR,guidePos:state.guidePos,speed:state.speed,guideVisible:state.guideVisible,padTB:state.padTB})); }catch{}
      manageAuto();
    });
  });
  showGuide?.addEventListener('change', ()=>{ state.guideVisible = !!showGuide.checked; render(); broadcastState(); try{ localStorage.setItem('tp_ui', JSON.stringify({fontSize:state.fontSize,padLR:state.padLR,guidePos:state.guidePos,speed:state.speed,guideVisible:state.guideVisible,padTB:state.padTB})); }catch{} });
  autoscroll?.addEventListener('change', ()=>{ state.autoscroll = !!autoscroll.checked; render(); broadcastState(); manageAuto(); });
  invertH?.addEventListener('change', ()=>{ state.invertH = !!invertH.checked; render(); broadcastState(); });
  invertV?.addEventListener('change', ()=>{ state.invertV = !!invertV.checked; render(); broadcastState(); });

  viewer?.addEventListener('scroll', ()=>{ if(isRemoteScroll) return; state.scrollTop = viewer.scrollTop; send({type:'scroll', scrollTop: state.scrollTop}); }, {passive:true});

  function scrollBy(amount){ if (!viewer) return; viewer.scrollTop = Math.max(0, viewer.scrollTop + amount); }
  document.addEventListener('keydown', (e)=>{
    const key = e.key;
    const tag = (document.activeElement && document.activeElement.tagName) || '';
    const typing = tag === 'TEXTAREA' || tag === 'INPUT' || document.activeElement?.isContentEditable;

    const isMac = navigator.platform.toUpperCase().includes('MAC');
    if ((isMac && e.metaKey && key.toLowerCase()==='s') || (!isMac && e.ctrlKey && key.toLowerCase()==='s')) { e.preventDefault(); document.dispatchEvent(new CustomEvent('tp-save')); return; }

    if (/^[a-zA-Z]$/.test(key) && !typing){ e.preventDefault(); jumpToLabel(key); return; }

    if (['ArrowUp','ArrowDown',' ','Spacebar','g','G','t','T','f','F'].includes(key)) e.preventDefault();
    if (key==='ArrowUp') scrollBy(-60);
    else if (key==='ArrowDown' || key==='Down') scrollBy(60);
    else if (key===' ' || key==='Spacebar'){ if (autoscroll){ autoscroll.checked = !autoscroll.checked; state.autoscroll = autoscroll.checked; render(); broadcastState(); manageAuto(); } }
    else if (key==='g' || key==='G'){ if (showGuide){ showGuide.checked = !showGuide.checked; state.guideVisible = showGuide.checked; render(); broadcastState(); } }
    else if (key==='t' || key==='T'){ if(!typing){ toggleUI(); } }
    else if (key==='f' || key==='F'){ if(!typing){ toggleFullscreen(); } }
  });

  window.addEventListener('resize', ()=>{ updatePadTBpx(); broadcastState(); });

  try{
    const cachedText = localStorage.getItem('tp_text');
    if (cachedText && scriptBox) { state.text = cachedText; scriptBox.value = cachedText; }
    const cachedUI = localStorage.getItem('tp_ui');
    if (cachedUI) {
      const u = JSON.parse(cachedUI);
      if (typeof u.fontSize==='number') state.fontSize=u.fontSize;
      if (typeof u.padLR==='number') state.padLR=u.padLR;
      if (typeof u.guidePos==='number') state.guidePos=u.guidePos;
      if (typeof u.speed==='number') state.speed=u.speed;
      if (typeof u.guideVisible==='boolean') state.guideVisible=u.guideVisible;
      if (typeof u.padTB==='number') state.padTB=u.padTB;
    }
  }catch{}

  if (!state.text && scriptBox) {
    state.text = `A SHORT EXAMPLE

Paste several paragraphs in the Script box above.

Each blank line starts a new paragraph ‚Äî the first 26 get A‚ÄìZ.

Press a letter key to jump that paragraph under the red guide.`;
    scriptBox.value = state.text;
  }

  render(); manageAuto(); syncUIToggleLabel();
})();
</script>

<!-- ===== Firebase: PUBLIC Save/Load (no login, no code) ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, getDoc, doc, deleteDoc, updateDoc,
    serverTimestamp, query, orderBy, enableIndexedDbPersistence
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  /* >>> NEW Firebase config (teleprompter2-81070) <<< */
  const firebaseConfig = {
    apiKey: "AIzaSyCko9ZyO8_Ez3jq_LqYehSjwe_yuieCZm0",
    authDomain: "teleprompter2-81070.firebaseapp.com",
    projectId: "teleprompter2-81070",
    storageBucket: "teleprompter2-81070.firebasestorage.app",
    messagingSenderId: "657511168839",
    appId: "1:657511168839:web:6bf1bf8339fd4a27c0ea62"
  };

  const app = initializeApp(firebaseConfig);
  const db   = getFirestore(app);

  // Remember project to reset stale doc meta when switching projects
  try{
    const PROJECT_ID = firebaseConfig.projectId;
    const prev = localStorage.getItem('tp_project_id');
    if (prev && prev !== PROJECT_ID){
      localStorage.removeItem('tp_doc_meta');
    }
    localStorage.setItem('tp_project_id', PROJECT_ID);
  }catch{}

  // Optional offline cache
  try{ await enableIndexedDbPersistence(db); }catch(e){ console.warn('Persistence not available:', e?.code || e); }

  const COLL = 'publicScripts'; // public collection

  // DOM
  const $ = (id)=>document.getElementById(id);
  const saveBtn   = $('saveScript');
  const loadBtn   = $('loadScript');
  const applyBtn  = $('applyScript');
  const scriptBox = $('script');
  const dlg       = $('loadDialog');
  const listEl    = $('savedList');
  const closeDlg  = $('closeDialog');
  const statusEl  = $('status');
  const setStatus = (m)=>{ if(statusEl) statusEl.textContent = m; };

  // Track current doc to allow update vs create
  let currentDocId = null;
  let currentName  = '';

  // Rehydrate doc meta if available (but may be stale after project switch guard above)
  try{
    const meta = localStorage.getItem('tp_doc_meta');
    if (meta){
      const m = JSON.parse(meta);
      currentDocId = m.id || null;
      currentName  = m.name || '';
    }
  }catch{}

  // Allow Ctrl/Cmd+S from teleprompter script
  document.addEventListener('tp-save', ()=>doSave());

  async function doSave(){
    const text = scriptBox?.value || '';
    const name = prompt('Enter a name for this script:', currentName || '');
    if (name === null) return;
    const trimmed = (name || '').trim();
    if (!trimmed) { alert('Please enter a valid name.'); return; }

    try{
      let didUpdate = false;
      if (currentDocId){
        try{
          const exists = await getDoc(doc(db, COLL, currentDocId));
          if (exists.exists()){
            await updateDoc(doc(db, COLL, currentDocId), {
              name: trimmed, text, updatedAt: serverTimestamp()
            });
            didUpdate = true;
          }
        }catch(e){
          // if update path fails, we'll fall back to create
          console.warn('Update path failed; will create new.', e);
        }
      }
      if (!didUpdate){
        const ref = await addDoc(collection(db, COLL), {
          name: trimmed, text, createdAt: serverTimestamp(), updatedAt: serverTimestamp()
        });
        currentDocId = ref.id; currentName = trimmed;
        setStatus?.(`Saved ‚Äú${trimmed}‚Äù.`);
        try{ localStorage.setItem('tp_doc_meta', JSON.stringify({id: currentDocId, name: currentName})); }catch{}
      } else {
        currentName = trimmed;
        setStatus?.(`Updated ‚Äú${trimmed}‚Äù.`);
      }
      try{ localStorage.setItem('tp_text', text); }catch{}
    }catch(err){
      console.error(err);
      alert('Save failed. See console for details.');
    }
  }

  async function showList(){
    dlg?.showModal();
    if (listEl) listEl.innerHTML = '<div class="muted">Loading‚Ä¶</div>';
    try{
      const qRef = query(collection(db, COLL), orderBy('updatedAt','desc'));
      const snap = await getDocs(qRef);
      if (!listEl) return;
      if (snap.empty){
        listEl.innerHTML = '<div class="muted">No saved scripts yet.</div>';
        return;
      }
      listEl.innerHTML = '';
      snap.forEach(docSnap=>{
        const d = docSnap.data();
        const when = d.updatedAt?.toDate ? d.updatedAt.toDate().toLocaleString() : '';
        const row = document.createElement('div');
        row.className = 'saved-item';
        row.innerHTML = `
          <div>
            <div class="saved-title">${d.name || '(untitled)'}</div>
            <div class="saved-meta">${when}</div>
          </div>
          <div class="saved-actions">
            <button data-id="${docSnap.id}" class="load">Load</button>
            <button data-id="${docSnap.id}" class="rename">Rename</button>
            <button data-id="${docSnap.id}" class="duplicate">Duplicate</button>
            <button data-id="${docSnap.id}" class="delete">Delete</button>
          </div>
        `;
        listEl.appendChild(row);
      });
    }catch(err){
      console.error(err);
      if (listEl) listEl.innerHTML = '<div class="muted">Failed to load list.</div>';
    }
  }

  // LOAD / RENAME / DUPLICATE / DELETE
  listEl?.addEventListener('click', async (e)=>{
    const id = e.target?.dataset?.id;
    if(!id) return;

    if(e.target.classList.contains('load')){
      try{
        const ds = await getDoc(doc(db, COLL, id));
        if (ds.exists()){
          const data = ds.data();
          const sb = document.getElementById('script');
          if (sb) sb.value = data.text || '';
          currentDocId = id; currentName = data.name || '';
          applyBtn?.click();
          setStatus?.(`Loaded ‚Äú${currentName || '(untitled)'}‚Äù.`);
          try{ localStorage.setItem('tp_doc_meta', JSON.stringify({id: currentDocId, name: currentName})); }catch{}
          dlg?.close();
        }
      }catch(err){ console.error(err); alert('Load failed.'); }
    }

    if(e.target.classList.contains('rename')){
      const ds = await getDoc(doc(db, COLL, id));
      if (!ds.exists()) return;
      const oldName = ds.data().name || '';
      const newName = prompt('Rename script to:', oldName);
      if (newName === null) return;
      const trimmed = (newName || '').trim();
      if (!trimmed) return alert('Please enter a valid name.');
      try{
        await updateDoc(doc(db, COLL, id), { name: trimmed, updatedAt: serverTimestamp() });
        if (currentDocId === id) { currentName = trimmed; try{ localStorage.setItem('tp_doc_meta', JSON.stringify({id: currentDocId, name: currentName})); }catch{} }
        showList();
      }catch(err){ console.error(err); alert('Rename failed.'); }
    }

    if(e.target.classList.contains('duplicate')){
      const ds = await getDoc(doc(db, COLL, id));
      if (!ds.exists()) return;
      const d = ds.data();
      const dupName = `${d.name || 'Copy'} (copy)`;
      try{
        await addDoc(collection(db, COLL), {
          name: dupName, text: d.text || '',
          createdAt: serverTimestamp(), updatedAt: serverTimestamp()
        });
        setStatus?.(`Duplicated as ‚Äú${dupName}‚Äù.`);
        showList();
      }catch(err){ console.error(err); alert('Duplicate failed.'); }
    }

    if(e.target.classList.contains('delete')){
      if(!confirm('Delete this saved script?')) return;
      try{
        await deleteDoc(doc(db, COLL, id));
        if (currentDocId === id){ currentDocId = null; currentName = ''; try{ localStorage.removeItem('tp_doc_meta'); }catch{} }
        showList();
      }catch(err){ console.error(err); alert('Delete failed.'); }
    }
  });

  saveBtn?.addEventListener('click', doSave);
  loadBtn?.addEventListener('click', showList);
  closeDlg?.addEventListener('click', ()=>dlg?.close());
</script>

<!--
FIRESTORE RULES for PUBLIC mode (paste in Console ‚Üí Firestore ‚Üí Rules):
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /publicScripts/{docId} {
      allow read, list, get: if true;
      allow create, update, delete: if true;
    }
  }
}
-->
</body>
</html>
