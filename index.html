<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dual‚ÄëWindow Teleprompter (Cloud Sync)</title>
  <style>
    :root{
      --bg:#000; --fg:#fff; --ui:#0b0b0b; --ui2:#131313; --mut:#a0a0a0;
      --fontPx:48; --lh:1.5; --col:60; --pad:6; --speed:90;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--ui);color:#eaeaea;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;z-index:20;background:var(--ui);border-bottom:1px solid #1e1e1e}
    .wrap{max-width:1150px;margin:0 auto;padding:12px 16px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    button{background:#1a1a1a;border:1px solid #2a2a2a;color:#eaeaea;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600}
    button:hover{background:#222;border-color:#3a3a3a}
    .primary{background:#1d4228;border-color:#2b5d3a;color:#d7ffe1}
    .primary:hover{background:#205230}
    .ghost{background:#101010;border-color:#222}
    .field{display:flex;gap:8px;align-items:center;padding:6px 10px;background:#101010;border:1px solid #222;border-radius:10px}
    .field input[type="range"]{width:160px}
    label{font-size:12px;color:#c8c8c8}
    .muted{color:var(--mut)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}}
    textarea{width:100%;min-height:200px;background:#060606;color:#eaeaea;border:1px solid #1f1f1f;border-radius:12px;padding:12px;font-size:15px;line-height:1.4}
    .viewerShell{height:60vh;background:#000;border:1px solid #1c1c1c;border-radius:16px;overflow:hidden}
    .viewer{height:100%;overflow:auto;padding:6vh calc(var(--pad) * 1vw);background:var(--bg);color:var(--fg)}
    .viewer::-webkit-scrollbar{width:12px}
    .viewer::-webkit-scrollbar-thumb{background:#2b2b2b;border-radius:8px}
    .prompt{margin:0 auto;max-width:calc(var(--col) * 1ch);font-size:calc(var(--fontPx) * 1px);line-height:var(--lh);letter-spacing:.02em;word-spacing:.08em}
    details.dev{margin-top:10px;background:#0f0f0f;border:1px solid #1f1f1f;border-radius:10px}
    details.dev summary{cursor:pointer;padding:8px 12px}
    details.dev pre{margin:0;padding:12px;border-top:1px solid #1f1f1f;white-space:pre-wrap}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    input[type="file"]{display:none}
    .tag{font-size:12px;padding:2px 6px;border:1px solid #2a2a2a;border-radius:8px;background:#121212;color:#cfcfcf}
    input.inline{background:#0d0d0d;border:1px solid #242424;color:#eaeaea;border-radius:8px;padding:8px 10px}
    .hint{font-size:12px;color:#bdbdbd}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="controls">
        <button id="openBtn" class="primary">Open Teleprompter Window</button>
        <button id="playBtn">‚ñ∂Ô∏é Start</button>
        <button id="pauseBtn">‚è∏Ô∏é Pause</button>
        <button id="topBtn">‚ü≤ Top</button>
        <button id="fsBtn">‚§¢ Fullscreen (Prompter)</button>
        <div class="field"><label>Speed (px/s)</label>
          <input type="range" id="speed" min="0" max="300" step="5" value="90"><span id="speedVal" class="muted">90</span>
        </div>
        <div class="field"><label>Font (px)</label>
          <input type="range" id="font" min="24" max="120" step="2" value="48"><span id="fontVal" class="muted">48</span>
        </div>
        <div class="field"><label>Line Height</label>
          <input type="range" id="lh" min="100" max="220" step="5" value="150"><span id="lhVal" class="muted">1.50</span>
        </div>
        <div class="field"><label>Column (ch)</label>
          <input type="range" id="cw" min="30" max="80" step="1" value="60"><span id="cwVal" class="muted">60</span>
        </div>
        <div class="field"><label>Side Pad (vw)</label>
          <input type="range" id="pad" min="0" max="20" step="1" value="6"><span id="padVal" class="muted">6</span>
        </div>
        <div class="field"><label>Flip Prompter</label>
          <input type="checkbox" id="flipChk">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="applyBtn" class="primary">Load to Preview & Prompter</button>
        <span class="tag">Autosave: <span id="autosaveStatus">ON</span></span>
        <div class="spacer"></div>
        <button id="exportBtn" title="Download .prompt file">üíæ Save to File</button>
        <label class="btn ghost" for="importFile">üìÇ Load from File</label>
        <input type="file" id="importFile" accept=".prompt,.json,.txt" />
        <button id="clearLocalBtn" class="ghost" title="Clear local autosave">üóëÔ∏è Clear Local</button>
      </div>

      <div class="row" style="margin-top:10px">
        <span class="tag">Cloud: <span id="cloudStatus">offline</span></span>
        <input id="docId" class="inline" style="min-width:320px" placeholder="Cloud Doc ID" readonly>
        <button id="newDocBtn" class="ghost">Ôºã New Cloud Doc</button>
        <button id="saveCloudBtn" class="ghost">‚òÅ Save to Cloud</button>
        <button id="loadCloudBtn" class="ghost">‚òÅ Load from Cloud</button>
        <button id="linkBtn" class="ghost">üîó Copy Share Link</button>
        <label class="hint">Open link on another device for live sync</label>
      </div>

      <div class="muted" style="margin-top:6px">
        Space: play/pause ‚Ä¢ ‚Üë/‚Üì: speed ¬±10 ‚Ä¢ Home: top ‚Ä¢ M: flip prompter ‚Ä¢ F: prompter fullscreen
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid" style="margin-top:14px">
      <section>
        <h3>Script</h3>
        <textarea id="script" placeholder="Paste your script here...">WELCOME TO THE DUAL‚ÄëWINDOW TELEPROMPTER

‚Ä¢ Click ‚ÄúOpen Teleprompter Window‚Äù and drag it to your extended display.
‚Ä¢ Use the controls to adjust speed, font, line height, and column width.
‚Ä¢ Toggle ‚ÄúFlip Prompter‚Äù to mirror only the external teleprompter.

Pro tip: Press Space to Start/Pause, and M to flip the prompter.</textarea>
      </section>
      <section>
        <h3>Operator Preview (manual scroll mirrors to prompter)</h3>
        <div class="viewerShell">
          <div id="viewer" class="viewer" tabindex="0">
            <div id="prompt" class="prompt"></div>
          </div>
        </div>
      </section>
    </div>

    <details class="dev">
      <summary>Dev Self‚ÄëTests (click to open)</summary>
      <pre id="testLog">(will run automatically)</pre>
    </details>
  </main>

  <!-- Firebase (module) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyALVu4YBscEBpIGn0N__x6HdT4yHbWbi3Q",
      authDomain: "teleprompter-1234b.firebaseapp.com",
      projectId: "teleprompter-1234b",
      storageBucket: "teleprompter-1234b.firebasestorage.app",
      messagingSenderId: "63079515130",
      appId: "1:63079515130:web:13d51e6f8aa62c4c0ada43"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Expose minimal cloud API to the main script via window
    const Cloud = { auth, db, doc, setDoc, getDoc, onSnapshot, serverTimestamp };
    window.__CLOUD__ = Cloud;

    // Anonymous sign-in
    onAuthStateChanged(auth, (user)=>{
      if (!user) {
        signInAnonymously(auth).catch(console.error);
      }
      // main JS will pick user via window.__getUID()
    });

    window.__getUID = () => (auth && auth.currentUser ? auth.currentUser.uid : null);
  </script>

  <script>
  // ================= Core State =================
  const LS_KEY = 'dualTeleprompter.v1';
  const state = {
    text: '',
    fontPx: 48,
    lineHeight: 1.5,
    colWidthCh: 60,
    sidePadVw: 6,
    speed: 90,
    flipPrompter: false,
    scrollTop: 0,
    autosave: true,
    cloud: { docId: null, live: true }
  };

  // ================= Elements =================
  const $ = (id)=>document.getElementById(id);
  const scriptEl = $('script'); // note: not used (reserved)
  const promptEl = $('prompt');
  const viewer   = $('viewer');
  const openBtn  = $('openBtn');
  const applyBtn = $('applyBtn');
  const playBtn  = $('playBtn');
  const pauseBtn = $('pauseBtn');
  const topBtn   = $('topBtn');
  const fsBtn    = $('fsBtn');

  const speed    = $('speed');
  const speedVal = $('speedVal');
  const font     = $('font');
  const fontVal  = $('fontVal');
  const lh       = $('lh');
  const lhVal    = $('lhVal');
  const cw       = $('cw');
  const cwVal    = $('cwVal');
  const pad      = $('pad');
  const padVal   = $('padVal');
  const flipChk  = $('flipChk');
  const testLog  = $('testLog');

  const exportBtn= $('exportBtn');
  const importFile = $('importFile');
  const clearLocalBtn = $('clearLocalBtn');
  const autosaveStatus = $('autosaveStatus');

  const cloudStatus = $('cloudStatus');
  const docIdInput = $('docId');
  const newDocBtn = $('newDocBtn');
  const saveCloudBtn = $('saveCloudBtn');
  const loadCloudBtn = $('loadCloudBtn');
  const linkBtn = $('linkBtn');

  let prompterWin = null;
  let pingTimer = null;
  let dirtySinceSave = false;
  let unsubscribe = null; // Firestore listener

  // ================= Prompter Window HTML =================
  function prompterHTML(){
    return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teleprompter</title>
  <style>
    :root{--bg:#000;--fg:#fff;--font:${state.fontPx}px;--lh:${state.lineHeight};--col:${state.colWidthCh}ch;--pad:${state.sidePadVw}vw}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden}
    #bar{position:fixed;inset:0 0 auto 0;background:#0b0b0bcc;color:#ddd;padding:6px 10px;font:12px/1.2 system-ui;display:flex;gap:8px;align-items:center}
    #bar button{background:#111;border:1px solid #2a2a2a;color:#eee;border-radius:8px;padding:6px 10px;cursor:pointer}
    #viewer{position:fixed;inset:32px 0 0 0;overflow:auto;background:#000;padding:6vh var(--pad)}
    #text{margin:0 auto;max-width:var(--col);font-size:var(--font);line-height:var(--lh);letter-spacing:.02em;word-spacing:.08em;transform:scaleX(${state.flipPrompter ? -1 : 1});}
  </style>
</head>
<body>
  <div id="bar">
    <button id="fs">‚§¢ Fullscreen</button>
    <span style="opacity:.8">Keys: <b>M</b> flip ‚Ä¢ <b>Esc</b> exit FS</span>
  </div>
  <div id="viewer"><div id="text"></div></div>

  <script>
    let openerWin = window.opener;
    const viewer = document.getElementById('viewer');
    const text = document.getElementById('text');
    const fsBtn = document.getElementById('fs');

    function apply(st){
      document.documentElement.style.setProperty('--font', st.fontPx + 'px');
      document.documentElement.style.setProperty('--lh', st.lineHeight);
      document.documentElement.style.setProperty('--col', st.colWidthCh + 'ch');
      document.documentElement.style.setProperty('--pad', st.sidePadVw + 'vw');
      text.style.transform = 'scaleX(' + (st.flipPrompter ? -1 : 1) + ')';
      if (text.dataset.raw !== st.text){ text.dataset.raw = st.text; text.textContent = st.text; }
      if (Math.abs(viewer.scrollTop - st.scrollTop) > 2){ viewer.scrollTop = st.scrollTop; }
    }

    window.addEventListener('message', (e)=>{
      const msg = e.data||{};
      if (msg.type === 'state') apply(msg.state);
      if (msg.type === 'scroll') viewer.scrollTop = msg.scrollTop|0;
      if (msg.type === 'fullscreen') document.documentElement.requestFullscreen?.();
      if (msg.type === 'ping') try{ opener.postMessage({type:'pong'}, '*'); }catch{}
    });

    fsBtn.addEventListener('click', ()=>{ document.documentElement.requestFullscreen?.(); });
    document.addEventListener('keydown', (e)=>{
      if (e.key.toLowerCase()==='m') openerWin && openerWin.postMessage({type:'flipRequest'}, '*');
    });

    window.onload = ()=>{ try{ openerWin && openerWin.postMessage({type:'ready'}, '*'); }catch{} }
  <\/script>
</body></html>`;
  }

  // ================= Open Prompter (no document.write) =================
  function openPrompter(){
    const html = prompterHTML();
    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    prompterWin = window.open(url, 'TeleprompterWindow', 'popup=yes,width=1200,height=800');
    if (!prompterWin){ alert('Pop‚Äëup blocked. Please allow pop‚Äëups.'); return; }

    if (pingTimer) clearInterval(pingTimer);
    pingTimer = setInterval(()=>{
      try{ if (prompterWin && !prompterWin.closed) prompterWin.postMessage({type:'ping'}, '*'); }catch{}
    }, 500);

    setTimeout(()=>{ try{ URL.revokeObjectURL(url); }catch{} }, 5000);
  }

  function send(type, payload){
    if (prompterWin && !prompterWin.closed){
      prompterWin.postMessage(Object.assign({type}, payload||{}), '*');
    }
  }

  window.addEventListener('message', (e)=>{
    if (e.source !== prompterWin) return;
    const msg = e.data||{};
    if (msg.type==='ready') send('state', {state});
    if (msg.type==='pong')  send('state', {state});
    if (msg.type==='flipRequest'){
      state.flipPrompter = !state.flipPrompter; flipChk.checked = state.flipPrompter; pushVisuals(); send('state',{state});
    }
  });

  // ================= Visuals =================
  function pushVisuals(){
    document.documentElement.style.setProperty('--fontPx', state.fontPx);
    document.documentElement.style.setProperty('--lh', state.lineHeight);
    document.documentElement.style.setProperty('--col', state.colWidthCh);
    document.documentElement.style.setProperty('--pad', state.sidePadVw);
    document.documentElement.style.setProperty('--speed', state.speed);
    $('prompt').textContent = state.text;
    $('viewer').scrollTop = state.scrollTop|0;
    markDirty();
  }

  function pushState(){ send('state', {state}); }

  // ================= Persistence (Local) =================
  const scriptBox = document.querySelector('textarea#script');
  function toPayload(){
    return {
      version: 1,
      savedAt: new Date().toISOString(),
      data: {
        text: state.text,
        fontPx: state.fontPx,
        lineHeight: state.lineHeight,
        colWidthCh: state.colWidthCh,
        sidePadVw: state.sidePadVw,
        speed: state.speed,
        flipPrompter: state.flipPrompter
      }
    };
  }
  function fromPayload(p){
    if (!p || !p.data) return;
    const d = p.data;
    state.text = String(d.text||'');
    state.fontPx = +d.fontPx||48;
    state.lineHeight = +d.lineHeight||1.5;
    state.colWidthCh = +d.colWidthCh||60;
    state.sidePadVw = +d.sidePadVw||6;
    state.speed = +d.speed||90;
    state.flipPrompter = !!d.flipPrompter;
  }
  function saveLocal(){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(toPayload())); $('autosaveStatus').textContent='ON'; }
    catch(e){ console.warn('Local save failed', e); $('autosaveStatus').textContent='ERR'; }
  }
  function loadLocal(){
    try{ const raw = localStorage.getItem(LS_KEY); if (!raw) return false; fromPayload(JSON.parse(raw)); return true; }
    catch(e){ console.warn('Local load failed', e); return false; }
  }
  function exportFile(){
    const blob = new Blob([JSON.stringify(toPayload(), null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const stamp = new Date().toISOString().replace(/[:.]/g,'-');
    a.href = url; a.download = `teleprompter-${stamp}.prompt`; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
    dirtySinceSave = false;
  }
  async function importFromFile(file){
    const text = await file.text();
    let payload; try{ payload = JSON.parse(text); } catch{ payload = { data: { text } }; }
    fromPayload(payload); applyControlsFromState(); pushVisuals(); pushState();
  }

  // ================= Cloud (Firestore) =================
  const getUID = ()=> (window.__getUID ? window.__getUID() : null);
  const cloudReady = ()=> !!(window.__CLOUD__ && window.__CLOUD__.db && getUID());
  const idRandom = (n=12)=> Array.from(crypto.getRandomValues(new Uint8Array(n))).map(x=>('0'+(x%36).toString(36)).slice(-1)).join('');

  function cloudDocRef(){
    const C = window.__CLOUD__;
    if (!C || !state.cloud.docId) return null;
    return C.doc(C.db, 'scripts', state.cloud.docId);
  }

  async function saveCloud(){
    if (!cloudReady()) return false;
    const C = window.__CLOUD__;
    const uid = getUID();
    const ref = cloudDocRef();
    if (!ref) return false;
    const payload = toPayload();
    payload.owner = uid; payload.updatedAt = C.serverTimestamp();
    await C.setDoc(ref, payload, { merge: true });
    dirtySinceSave = false; paintCloudStatus('saved');
    return true;
  }

  async function loadCloud(){
    if (!cloudReady()) return false;
    const C = window.__CLOUD__;
    const ref = cloudDocRef();
    if (!ref) return false;
    const snap = await C.getDoc(ref);
    if (!snap.exists()) return false;
    fromPayload(snap.data()); applyControlsFromState(); pushVisuals(); pushState();
    paintCloudStatus('loaded');
    return true;
  }

  function listenCloud(){
    if (unsubscribe) { unsubscribe(); unsubscribe=null; }
    const C = window.__CLOUD__;
    const ref = cloudDocRef();
    if (!ref) return;
    unsubscribe = C.onSnapshot(ref, (snap)=>{
      if (!snap.exists()) return;
      const before = JSON.stringify(toPayload().data);
      const incoming = snap.data();
      // ignore our own immediate writes to avoid loops
      if (incoming && incoming.data && JSON.stringify(incoming.data)!==before){
        fromPayload(incoming); applyControlsFromState(); pushVisuals();
      }
    });
  }

  function paintCloudStatus(mode){
    const uid = getUID();
    $('cloudStatus').textContent = uid ? (mode? mode : 'online') : 'offline';
    $('docId').value = state.cloud.docId || '';
  }

  function ensureDocId(){
    const url = new URL(location.href);
    const q = url.searchParams.get('doc');
    if (q) state.cloud.docId = q;
    if (!state.cloud.docId) state.cloud.docId = idRandom(12);
    // write back to URL (no reload)
    url.searchParams.set('doc', state.cloud.docId);
    history.replaceState(null, '', url.toString());
    paintCloudStatus();
  }

  function copyShareLink(){
    const url = new URL(location.href);
    url.searchParams.set('doc', state.cloud.docId);
    navigator.clipboard.writeText(url.toString()).then(()=>{
      linkBtn.textContent = '‚úÖ Link Copied'; setTimeout(()=>linkBtn.textContent='üîó Copy Share Link', 1200);
    }).catch(()=>{
      alert('Copy failed. You can manually copy from the address bar.');
    });
  }

  function markDirty(){
    dirtySinceSave = true; if (state.autosave) saveLocal();
    // If cloud live sync and ready, debounce write
    if (state.cloud.live && cloudReady())
      debounceSaveCloud();
  }

  let cloudSaveTimer=null; function debounceSaveCloud(){
    clearTimeout(cloudSaveTimer); cloudSaveTimer = setTimeout(()=>{ saveCloud(); }, 600);
  }

  // ================= Wiring =================
  function applyControlsFromState(){
    document.querySelector('#script').value = state.text;
    font.value = state.fontPx; fontVal.textContent = state.fontPx;
    lh.value = Math.round(state.lineHeight*100); lhVal.textContent = state.lineHeight.toFixed(2);
    cw.value = state.colWidthCh; cwVal.textContent = state.colWidthCh;
    pad.value = state.sidePadVw; padVal.textContent = state.sidePadVw;
    speed.value = state.speed; speedVal.textContent = state.speed;
    flipChk.checked = state.flipPrompter;
  }

  (function init(){
    // Load local, then URL doc, then cloud
    const ok = loadLocal();
    if (!ok) state.text = document.querySelector('#script').value;
    ensureDocId(); paintCloudStatus();
    applyControlsFromState(); pushVisuals();

    // Inputs
    const relabel = ()=>{
      speedVal.textContent = state.speed;
      fontVal.textContent  = state.fontPx;
      lhVal.textContent    = state.lineHeight.toFixed(2);
      cwVal.textContent    = state.colWidthCh;
      padVal.textContent   = state.sidePadVw;
    };
    const readAll = ()=>{
      state.text        = document.querySelector('#script').value.replace(/\r\n?/g, '\n');
      state.fontPx      = parseInt(font.value,10);
      state.lineHeight  = parseInt(lh.value,10)/100;
      state.colWidthCh  = parseInt(cw.value,10);
      state.sidePadVw   = parseInt(pad.value,10);
      state.speed       = parseInt(speed.value,10);
      state.flipPrompter= !!flipChk.checked;
    };

    document.querySelector('#script').addEventListener('input', ()=>{ state.text = document.querySelector('#script').value; pushVisuals(); pushState(); });
    ;[font,lh,cw,pad].forEach(inp=>inp.addEventListener('input', ()=>{ readAll(); relabel(); pushVisuals(); pushState(); }));
    speed.addEventListener('input', ()=>{ state.speed = parseInt(speed.value,10); relabel(); pushVisuals(); });
    flipChk.addEventListener('change', ()=>{ state.flipPrompter = flipChk.checked; pushState(); pushVisuals(); });

    applyBtn.addEventListener('click', ()=>{ readAll(); pushVisuals(); pushState(); });
    openBtn.addEventListener('click', ()=>{ openPrompter(); setTimeout(()=>{ readAll(); pushVisuals(); pushState(); }, 50); });
    topBtn.addEventListener('click', ()=>{ state.scrollTop = 0; pushVisuals(); send('scroll',{scrollTop:0}); });
    fsBtn.addEventListener('click', ()=>{ send('fullscreen'); });

    // Persistence actions
    exportBtn.addEventListener('click', exportFile);
    importFile.addEventListener('change', (e)=>{ const f=e.target.files[0]; if (f) importFromFile(f); e.target.value=''; });
    clearLocalBtn.addEventListener('click', ()=>{ localStorage.removeItem(LS_KEY); autosaveStatus.textContent='OFF'; });

    // Cloud controls
    newDocBtn.addEventListener('click', ()=>{ state.cloud.docId = idRandom(12); const url=new URL(location.href); url.searchParams.set('doc', state.cloud.docId); history.replaceState(null,'',url.toString()); paintCloudStatus(); listenCloud(); saveCloud(); });
    saveCloudBtn.addEventListener('click', ()=> saveCloud());
    loadCloudBtn.addEventListener('click', ()=> loadCloud());
    linkBtn.addEventListener('click', copyShareLink);

    // Start listening as soon as Firebase auth is ready
    const waitAuth = setInterval(()=>{
      if (cloudReady()){
        clearInterval(waitAuth);
        paintCloudStatus();
        listenCloud();
        // If there is a cloud doc and it's empty, push current; else pull
        loadCloud().then(ok=>{ if(!ok) saveCloud(); });
      }
    }, 300);

    // Warn on close if unsaved changes
    window.addEventListener('beforeunload', (e)=>{ if (dirtySinceSave){ e.preventDefault(); e.returnValue=''; } });

    // Self‚Äëtests
    setTimeout(runSelfTests, 0);
  })();

  // ================= Autoscroll =================
  let playing=false, rafId=0, lastTs=0;
  function setPlaying(v){ if (playing===v) return; playing=v; lastTs=0; playBtn.textContent = playing? '‚èµ Playing' : '‚ñ∂Ô∏é Start'; if (playing) rafId = requestAnimationFrame(step); else cancelAnimationFrame(rafId); }
  function togglePlay(){ setPlaying(!playing); }
  function bumpSpeed(d){ state.speed = Math.max(0, Math.min(300, state.speed + d)); speed.value = state.speed; $('speedVal').textContent = state.speed; pushVisuals(); }
  function step(ts){ if (!playing) return; if (!lastTs) lastTs = ts; const dt = (ts - lastTs)/1000; lastTs = ts; state.scrollTop = Math.min($('viewer').scrollHeight - $('viewer').clientHeight, state.scrollTop + state.speed * dt); $('viewer').scrollTop = state.scrollTop; send('scroll', {scrollTop: state.scrollTop}); rafId = requestAnimationFrame(step); }

  // ================= Self‚ÄëTests =================
  function log(line){ $('testLog').textContent += ($('testLog').textContent ? '\n' : '') + line; }
  function expect(name, cond){ log((cond? '‚úÖ':'‚ùå') + ' ' + name + (cond?'':' ‚Äî failed')); }
  function runSelfTests(){
    const html = prompterHTML();
    expect('prompterHTML() returns a string', typeof html === 'string' && html.length > 100);
    expect('Inner </script> is escaped', /<\\/script>/.test(html));
    try{ const parser = new DOMParser(); const doc = parser.parseFromString(html, 'text/html'); expect('Contains #viewer', !!doc.getElementById('viewer')); expect('Contains #text', !!doc.getElementById('text')); }catch(e){ expect('DOMParser parse', false); }
    try{ const src = openPrompter.toString(); expect('openPrompter uses Blob', /new Blob\(\[html\], \{ type: 'text\/html' \}\)/.test(src)); expect('openPrompter avoids document.write', !/document\.write/.test(src)); }catch(e){ expect('openPrompter introspection', false); }
    expect('Cloud API injected', !!window.__CLOUD__);
  }

  // ================= Keyboard =================
  document.addEventListener('keydown', (e)=>{
    const tag = (e.target && e.target.tagName)||''; if (/INPUT|TEXTAREA/.test(tag)) return;
    if (e.key === ' '){ e.preventDefault(); togglePlay(); }
    else if (e.key === 'ArrowDown'){ e.preventDefault(); bumpSpeed(+10); }
    else if (e.key === 'ArrowUp'){ e.preventDefault(); bumpSpeed(-10); }
    else if (e.key === 'Home'){ e.preventDefault(); state.scrollTop = 0; pushVisuals(); send('scroll',{scrollTop:0}); }
    else if (e.key.toLowerCase()==='m'){ state.flipPrompter = !state.flipPrompter; $('flipChk').checked = state.flipPrompter; pushState(); pushVisuals(); }
    else if (e.key.toLowerCase()==='f'){ send('fullscreen'); }
  });
  
  </script>
</body>
</html>
